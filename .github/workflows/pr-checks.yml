name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  pr-metadata:
    name: PR Metadata Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false && github.actor != 'dependabot[bot]'

    steps:
      - name: Check PR title
        run: |
          TITLE="${{ github.event.pull_request.title }}"

          # Check for conventional commit style (optional but nice)
          if [[ ! "$TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|ci|perf|build)(\(.+\))?:\ .+ ]]; then
            echo "::warning::PR title doesn't follow conventional commit style"
            echo "Consider using: feat/fix/docs/etc: description"
          fi

      - name: Check PR description
        run: |
          # Skip detailed PR body check - just verify it exists
          # PR body can contain special characters that break shell parsing
          BODY_LENGTH=$(echo '${{ github.event.pull_request.body }}' | wc -c)

          if [ "$BODY_LENGTH" -lt 10 ]; then
            echo "::error::PR description is too short or empty"
            echo "Please provide a description of your changes"
            exit 1
          fi

  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check pyproject.toml dependencies
        run: |
          # Verify minimal runtime dependencies:
          # - Python 3.11+: Zero dependencies (uses stdlib tomllib)
          # - Python 3.10: Only tomli (conditional dependency for TOML parsing)

          echo "Checking runtime dependencies..."

          # Extract dependencies array from pyproject.toml (stop at closing bracket)
          DEPS=$(sed -n '/^dependencies = \[/,/^\]/p' pyproject.toml | grep -v "^dependencies = \[" | grep -v "^\]" | grep -v "^#" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v "^$")

          if [ -z "$DEPS" ]; then
            echo "✓ Zero runtime dependencies (empty array)"
            exit 0
          fi

          # Check that only tomli is present and it's conditional on Python < 3.11
          if echo "$DEPS" | grep -q '"tomli>=2.0.0; python_version < '"'"'3.11'"'"'"'; then
            echo "✓ Valid conditional dependency: tomli for Python 3.10"

            # Verify no other dependencies
            DEP_COUNT=$(echo "$DEPS" | wc -l | tr -d ' ')
            if [ "$DEP_COUNT" -eq 1 ]; then
              echo "✓ Only tomli dependency present (Python 3.11+ has zero deps)"
              exit 0
            else
              echo "::error::Multiple runtime dependencies detected!"
              echo "Expected: only tomli for Python 3.10, zero for Python 3.11+"
              echo "Found: $DEP_COUNT dependencies"
              exit 1
            fi
          else
            echo "::error::Unexpected runtime dependencies detected!"
            echo "ascii-guard should have:"
            echo "  - Python 3.11+: Zero dependencies (uses stdlib tomllib)"
            echo "  - Python 3.10: Only tomli (conditional)"
            echo ""
            echo "Found:"
            echo "$DEPS"
            exit 1
          fi

      - name: Check for forbidden imports
        run: |
          # Check that we're not importing forbidden packages
          FORBIDDEN="click|typer|colorama|rich|markdown|mistune|commonmark"

          if grep -r -E "^import ($FORBIDDEN)|^from ($FORBIDDEN)" src/ --include="*.py"; then
            echo "::error::Forbidden dependencies detected in imports!"
            echo "ascii-guard must only use Python stdlib"
            exit 1
          fi
          echo "✓ No forbidden imports detected"

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Check code formatting
        run: |
          ruff format --check src/ tests/

      - name: Run linter
        run: |
          ruff check src/ tests/

      - name: Type checking
        run: |
          mypy src/

      - name: Check for TODO/FIXME comments
        run: |
          if grep -r "TODO\|FIXME" src/ --include="*.py"; then
            echo "::warning::Found TODO/FIXME comments in code"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Run Bandit security scan
        continue-on-error: true
        run: |
          python -m pip install --upgrade pip
          pip install 'bandit[toml]'
          bandit -r src/ -ll || true

      - name: Check for secrets
        run: |
          if grep -r -E "(password|secret|api_key|token).*=" src/ --include="*.py" | grep -v "# pragma: allowlist secret" || false; then
            echo "::warning::Potential secrets detected in code"
          else
            echo "✓ No secrets detected"
          fi

  test-coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run tests with coverage
        run: |
          pytest --cov=ascii_guard --cov-report=term-missing --cov-fail-under=80

      - name: Generate coverage comment
        run: |
          coverage report --format=markdown > coverage.md || echo "No coverage data"
          if [ -f coverage.md ]; then
            cat coverage.md
          fi

  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check README exists
        run: |
          if [ ! -f README.md ]; then
            echo "::error::README.md not found"
            exit 1
          fi

      - name: Check for broken links in docs
        run: |
          # Simple check for common broken link patterns
          if grep -r "\[.*\]()" docs/ README.md 2>/dev/null; then
            echo "::warning::Found empty links in documentation"
          fi

      - name: Validate markdown files
        run: |
          # Check that markdown files are valid
          for file in $(find . -name "*.md" -not -path "./.*"); do
            if [ ! -s "$file" ]; then
              echo "::warning::Empty markdown file: $file"
            fi
          done
