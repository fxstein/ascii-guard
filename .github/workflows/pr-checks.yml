name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read

jobs:
  pr-metadata:
    name: PR Metadata Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false && github.actor != 'dependabot[bot]'

    steps:
      - name: Check PR title
        run: |
          TITLE="${{ github.event.pull_request.title }}"

          # Check for conventional commit style (optional but nice)
          if [[ ! "$TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|ci|perf|build)(\(.+\))?:\ .+ ]]; then
            echo "::warning::PR title doesn't follow conventional commit style"
            echo "Consider using: feat/fix/docs/etc: description"
          fi

      - name: Check PR description
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Skip detailed PR body check - just verify it exists
          # Use printf to avoid shell parsing issues with special characters
          if python -c "import os, re, sys; body=os.environ.get('PR_BODY',''); sys.exit(1 if re.search(r'<[^>]+>', body or '') else 0)"
          then
            : # No HTML found
          else
            echo "::error::PR description contains HTML. Please remove all HTML tags."
            exit 1
          fi

          BODY_LENGTH=$(printf '%s' "${PR_BODY}" | wc -c)

          if [ "$BODY_LENGTH" -lt 10 ]; then
            echo "::error::PR description is too short or empty"
            echo "Please provide a description of your changes"
            exit 1
          fi

  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6

      - name: Set up Python 3.14 with uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b  # v7
        with:
          version: "latest"
          python-version: "3.14"
          enable-cache: true
          cache-dependency-glob: "uv.lock"
          save-cache: false

      - name: Install package (no dev dependencies)
        run: |
          uv venv --python 3.12 --managed-python
          uv sync --frozen

      - name: Check runtime dependencies using uv
        run: |
          # Use uv to reliably check installed runtime dependencies
          # Python 3.11+: Should have zero runtime dependencies (uses stdlib tomllib)
          # Python 3.10: Should only have tomli (conditional dependency)

          echo "Checking runtime dependencies using uv..."

          # Get list of installed packages, excluding build tools and ascii-guard itself
          INSTALLED=$(uv pip list --format=freeze | grep -v "^ascii-guard" | grep -v "^pip==" | grep -v "^setuptools==" | grep -v "^wheel==" || true)

          if [ -z "$INSTALLED" ]; then
            echo "✓ Zero runtime dependencies verified (Python 3.11+)"
            exit 0
          fi

          # Check if only tomli is present (for Python 3.10 compatibility)
          TOMLI_ONLY=$(echo "$INSTALLED" | grep -c "^tomli==" || echo "0")
          DEP_COUNT=$(echo "$INSTALLED" | wc -l | tr -d ' ')

          if [ "$TOMLI_ONLY" -eq 1 ] && [ "$DEP_COUNT" -eq 1 ]; then
            echo "✓ Valid: Only tomli dependency (Python 3.10 compatibility)"
            exit 0
          else
            echo "::error::Unexpected runtime dependencies detected!"
            echo "ascii-guard should have:"
            echo "  - Python 3.11+: Zero dependencies (uses stdlib tomllib)"
            echo "  - Python 3.10: Only tomli (conditional)"
            echo ""
            echo "Found $DEP_COUNT dependency/dependencies:"
            echo "$INSTALLED"
            exit 1
          fi

      - name: Check for forbidden imports
        run: |
          # Check that we're not importing forbidden packages
          FORBIDDEN="click|typer|colorama|rich|markdown|mistune|commonmark"

          if grep -r -E "^import ($FORBIDDEN)|^from ($FORBIDDEN)" src/ --include="*.py"; then
            echo "::error::Forbidden dependencies detected in imports!"
            echo "ascii-guard must only use Python stdlib"
            exit 1
          fi
          echo "✓ No forbidden imports detected"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6

      - name: Set up Python 3.14 with uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b  # v7
        with:
          version: "latest"
          python-version: "3.14"
          enable-cache: true
          cache-dependency-glob: "uv.lock"
          cache-suffix: "security-scan"

      - name: Run Bandit security scan
        continue-on-error: true
        run: |
          uv venv --python 3.12 --managed-python
          uv pip install 'bandit[toml]'
          uv run bandit -r src/ -ll || true

      - name: Check for secrets
        run: |
          if grep -r -E "(password|secret|api_key|token).*=" src/ --include="*.py" | grep -v "# pragma: allowlist secret" || false; then
            echo "::warning::Potential secrets detected in code"
          else
            echo "✓ No secrets detected"
          fi

  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6

      - name: Check README exists
        run: |
          if [ ! -f README.md ]; then
            echo "::error::README.md not found"
            exit 1
          fi

      - name: Check for broken links in docs
        run: |
          # Simple check for common broken link patterns
          if grep -r "\[.*\]()" docs/ README.md 2>/dev/null; then
            echo "::warning::Found empty links in documentation"
          fi

      - name: Validate markdown files
        run: |
          # Check that markdown files are valid
          for file in $(find . -name "*.md" -not -path "./.*"); do
            if [ ! -s "$file" ]; then
              echo "::warning::Empty markdown file: $file"
            fi
          done
